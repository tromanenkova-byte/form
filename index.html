<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Заявка на консультацию</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#ffffff; --text:#1a1a1a; --muted:#666; --card:#fff; --acc:#0a84ff; --border:#ececec;
    }
    html,body{margin:0;padding:0;height:100%;}
    body{
      background:var(--bg); color:var(--text); font:16px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    .wrap{max-width:680px;margin:0 auto;padding:16px 14px 28px;}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    h1{font-size:20px;margin:0 0 8px;}
    p.lead{margin:0 0 14px;color:var(--muted)}
    label{display:block;font-weight:600;margin:14px 0 6px;}
    .row{display:flex; gap:10px;}
    .row > div{flex:1}
    input, select, textarea{
      width:100%; box-sizing:border-box;
      border:1px solid var(--border); border-radius:10px; padding:12px 12px;
      background:#fff; color:var(--text); font-size:16px; outline:none;
    }
    textarea{min-height:96px; resize:vertical;}
    .hint{font-size:13px; color:var(--muted); margin-top:6px;}
    .consent{display:flex; gap:10px; align-items:flex-start; margin:14px 0;}
    .consent input{margin-top:3px; width:auto;}
    .inline-btn{
      display:inline-block; padding:12px 16px; border-radius:12px; text-decoration:none;
      background:var(--acc); color:#fff; font-weight:600; border:0; cursor:pointer; width:100%;
    }
    .meta{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    .footer{margin-top:10px; text-align:center}
    .hidden{display:none;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Заявка на консультацию</h1>
    <p class="lead">Оставьте контакты и выберите формат — я свяжусь для подтверждения времени.</p>

    <form id="leadForm">
      <label for="format">Формат</label>
      <select id="format" name="format" required>
        <option value="" disabled selected>Выберите формат…</option>
        <option value="diag">Диагностика, 20 минут</option>
        <option value="session">Индивидуальная сессия, 50 минут</option>
        <option value="pack4">Пакет из 4 сессий (со скидкой)</option>
        <option value="pack8">Пакет из 8 сессий (со скидкой)</option>
      </select>

      <label for="name">Ваше имя и фамилия</label>
      <input id="name" name="name" type="text" placeholder="Например: Анна Иванова" required>

      <div class="row">
        <div>
          <label for="username">Ник Telegram (если есть)</label>
          <input id="username" name="username" type="text" placeholder="@username">
          <div class="hint">Подставится автоматически, если открыли из Telegram</div>
        </div>
        <div>
          <label for="phone">Телефон / WhatsApp</label>
          <input id="phone" name="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="+7 900 000-00-00" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="date_pref">Желаемая дата (необязательно)</label>
          <input id="date_pref" name="date_pref" type="date">
        </div>
        <div>
          <label for="time_pref">Желательное время (необязательно)</label>
          <input id="time_pref" name="time_pref" type="time">
        </div>
      </div>

      <label for="comment">Коротко о запросе (необязательно)</label>
      <textarea id="comment" name="comment" placeholder="Что сейчас важно, с чем хотите прийти?"></textarea>

      <div class="consent">
        <input id="consent" type="checkbox" required>
        <label for="consent" style="font-weight:400">
          Согласен(а) с обработкой персональных данных и правилами работы.
          <a id="rulesLink" href="#" target="_blank" rel="noopener">Открыть правила</a>
        </label>
      </div>

      <button id="submitBtn" type="submit" class="inline-btn">Отправить заявку</button>
      <div id="sentNote" class="footer hidden">✅ Заявка отправлена. Окно можно закрыть.</div>
    </form>

    <div class="meta">Если форма открыта вне Telegram, отправка из браузера может быть недоступна — используйте кнопку внутри бота.</div>
  </div>
</div>

<script>
  // ============= НАСТРОЙКИ (можно отредактировать) =============
  const RULES_URL = "";            // сюда можно поставить ссылку на ваши правила (если есть страница)
  const DEFAULT_FORMAT = "";       // можно указать "diag" | "session" | "pack4" | "pack8" как дефолт
  // =============================================================

  const tg = window.Telegram?.WebApp;
  const form = document.getElementById('leadForm');
  const btn = document.getElementById('submitBtn');
  const note = document.getElementById('sentNote');
  const rulesLink = document.getElementById('rulesLink');

  // Применяем тему Telegram
  function applyTheme(){
    if(!tg) return;
    const th = tg.themeParams || {};
    const toHex = (c) => c ? (c.startsWith('#') ? c : '#'+c) : null;
    const map = {
      '--bg': toHex(th.bg_color) || getComputedStyle(document.documentElement).getPropertyValue('--bg'),
      '--text': toHex(th.text_color) || getComputedStyle(document.documentElement).getPropertyValue('--text'),
      '--card': toHex(th.secondary_bg_color) || '#ffffff',
      '--acc': toHex(th.button_color) || '#0a84ff',
      '--border': '#e9e9ea',
      '--muted': toHex(th.hint_color) || '#666666'
    };
    Object.entries(map).forEach(([k,v])=> v && document.documentElement.style.setProperty(k, v));
    if (tg.colorScheme === 'dark'){
      document.documentElement.style.setProperty('--border', '#2a2a2a');
    }
    try{ tg.expand(); }catch(e){}
  }

  function prefillFromTelegram(){
    if(!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) return;
    const u = tg.initDataUnsafe.user;
    const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
    if(fullName && !document.getElementById('name').value){
      document.getElementById('name').value = fullName;
    }
    if(u.username && !document.getElementById('username').value){
      document.getElementById('username').value = '@' + u.username;
    }
  }

  function preselectFormat(){
    // ?type=diag|session|pack4|pack8  или DEFAULT_FORMAT
    const url = new URL(window.location.href);
    const t = (url.searchParams.get('type') || DEFAULT_FORMAT || '').trim().toLowerCase();
    const map = { 'diag':'diag', 'diagnostic':'diag', '20':'diag', 'd':'diag',
                  'session':'session', '50':'session', 's':'session',
                  'pack4':'pack4', 'p4':'pack4', '4':'pack4',
                  'pack8':'pack8', 'p8':'pack8', '8':'pack8'};
    const val = map[t];
    if(val){
      const sel = document.getElementById('format');
      sel.value = val;
    }
  }

  function setupMainButton(){
    if(!tg) return;
    tg.MainButton.setText('Отправить заявку');
    tg.MainButton.show();
    tg.onEvent('mainButtonClicked', submitForm);
  }

  function validate(){
    const req = ['format','name','phone'];
    for(const id of req){
      const el = document.getElementById(id);
      if(!el || !el.value) return false;
    }
    const consent = document.getElementById('consent');
    if(!consent.checked) return false;
    return true;
  }

  function submitForm(e){
    if(e) e.preventDefault();
    if(!validate()){
      alert('Проверьте обязательные поля и согласие с правилами.');
      return;
    }
    const payload = {
      kind: 'lead',
      at: new Date().toISOString(),
      // user из Telegram (если доступен)
      user: tg?.initDataUnsafe?.user ? {
        id: tg.initDataUnsafe.user.id,
        username: tg.initDataUnsafe.user.username || '',
        name: [tg.initDataUnsafe.user.first_name, tg.initDataUnsafe.user.last_name].filter(Boolean).join(' ')
      } : null,
      // данные формы
      format: document.getElementById('format').value,        // diag | session | pack4 | pack8
      name: document.getElementById('name').value.trim(),
      username: document.getElementById('username').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      date_pref: document.getElementById('date_pref').value || '',
      time_pref: document.getElementById('time_pref').value || '',
      comment: document.getElementById('comment').value.trim(),
      consent: true,
      tz: Intl.DateTimeFormat().resolvedOptions().timeZone || ''
    };

    if(tg && typeof tg.sendData === 'function'){
      try{
        tg.sendData(JSON.stringify(payload));
        btn.disabled = true;
        note.classList.remove('hidden');
        setTimeout(()=> { try{ tg.close(); }catch(e){} }, 900);
      }catch(err){
        console.error(err);
        alert('Не удалось отправить через Telegram. Попробуйте позже.');
      }
    }else{
      // Фолбэк вне Telegram: просто показать собранные данные
      console.log('Payload (local preview):', payload);
      btn.disabled = true;
      note.classList.remove('hidden');
      alert('Форма открыта вне Telegram. Откройте её через кнопку в боте для отправки.');
    }
  }

  // Привязки
  form.addEventListener('submit', submitForm);

  // Инициализация
  applyTheme();
  prefillFromTelegram();
  preselectFormat();
  setupMainButton();

  // Ссылка на правила, если задана
  if(RULES_URL){
    rulesLink.href = RULES_URL;
  }else{
    rulesLink.removeAttribute('href');
    rulesLink.addEventListener('click', (e)=>{ e.preventDefault(); alert('Правила доступны в разделе «📝 Правила» бота.'); });
  }
</script>
</body>
</html>
