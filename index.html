<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#ffffff; --text:#1a1a1a; --muted:#666; --card:#fff; --acc:#0a84ff; --border:#ececec;
    }
    html,body{margin:0;padding:0;height:100%;}
    body{
      background:var(--bg); color:var(--text); font:16px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    .wrap{max-width:680px;margin:0 auto;padding:16px 14px 28px;}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    h1{font-size:20px;margin:0 0 8px;}
    p.lead{margin:0 0 14px;color:var(--muted)}
    label{display:block;font-weight:600;margin:14px 0 6px;}
    .row{display:flex; gap:10px;}
    .row > div{flex:1}
    input, select, textarea{
      width:100%; box-sizing:border-box;
      border:1px solid var(--border); border-radius:10px; padding:12px 12px;
      background:#fff; color:var(--text); font-size:16px; outline:none;
    }
    textarea{min-height:96px; resize:vertical;}
    .hint{font-size:13px; color:var(--muted); margin-top:6px;}
    .consent{display:flex; gap:10px; align-items:flex-start; margin:14px 0;}
    .consent input{margin-top:3px; width:auto;}
    .inline-btn{
      display:inline-block; padding:12px 16px; border-radius:12px; text-decoration:none;
      background:var(--acc); color:#fff; font-weight:600; border:0; cursor:pointer; width:100%;
    }
    .meta{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    .footer{margin-top:10px; text-align:center}
    .hidden{display:none;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>–ó–∞—è–≤–∫–∞ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</h1>
    <p class="lead">–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç ‚Äî —è —Å–≤—è–∂—É—Å—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.</p>

    <form id="leadForm">
      <label for="format">–§–æ—Ä–º–∞—Ç</label>
      <select id="format" name="format" required>
        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç‚Ä¶</option>
        <option value="diag">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, 20 –º–∏–Ω—É—Ç</option>
        <option value="session">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è, 50 –º–∏–Ω—É—Ç</option>
        <option value="pack4">–ü–∞–∫–µ—Ç –∏–∑ 4 —Å–µ—Å—Å–∏–π (—Å–æ —Å–∫–∏–¥–∫–æ–π)</option>
        <option value="pack8">–ü–∞–∫–µ—Ç –∏–∑ 8 —Å–µ—Å—Å–∏–π (—Å–æ —Å–∫–∏–¥–∫–æ–π)</option>
      </select>

      <label for="name">–í–∞—à–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è</label>
      <input id="name" name="name" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞" required>

      <div class="row">
        <div>
          <label for="username">–ù–∏–∫ Telegram (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
          <input id="username" name="username" type="text" placeholder="@username">
          <div class="hint">–ü–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –∏–∑ Telegram</div>
        </div>
        <div>
          <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω / WhatsApp</label>
          <input id="phone" name="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="+7 900 000-00-00" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="date_pref">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="date_pref" name="date_pref" type="date">
        </div>
        <div>
          <label for="time_pref">–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="time_pref" name="time_pref" type="time">
        </div>
      </div>

      <label for="comment">–ö–æ—Ä–æ—Ç–∫–æ –æ –∑–∞–ø—Ä–æ—Å–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="comment" name="comment" placeholder="–ß—Ç–æ —Å–µ–π—á–∞—Å –≤–∞–∂–Ω–æ, —Å —á–µ–º —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–π—Ç–∏?"></textarea>

      <div class="consent">
        <input id="consent" type="checkbox" required>
        <label for="consent" style="font-weight:400">
          –°–æ–≥–ª–∞—Å–µ–Ω(–∞) —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Ä–∞–±–æ—Ç—ã.
          <a id="rulesLink" href="#" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∞–≤–∏–ª–∞</a>
        </label>
      </div>

      <button id="submitBtn" type="submit" class="inline-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      <div id="sentNote" class="footer hidden">‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∫–Ω–æ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å.</div>
    </form>

    <div class="meta">–ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–Ω–µ Telegram, –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞.</div>
  </div>
</div>

<script>
  // ============= –ù–ê–°–¢–†–û–ô–ö–ò (–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) =============
  const RULES_URL = "";            // —Å—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
  const DEFAULT_FORMAT = "";       // –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å "diag" | "session" | "pack4" | "pack8" –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç
  // =============================================================

  const tg = window.Telegram?.WebApp;
  const form = document.getElementById('leadForm');
  const btn = document.getElementById('submitBtn');
  const note = document.getElementById('sentNote');
  const rulesLink = document.getElementById('rulesLink');

  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
  function applyTheme(){
    if(!tg) return;
    const th = tg.themeParams || {};
    const toHex = (c) => c ? (c.startsWith('#') ? c : '#'+c) : null;
    const map = {
      '--bg': toHex(th.bg_color) || getComputedStyle(document.documentElement).getPropertyValue('--bg'),
      '--text': toHex(th.text_color) || getComputedStyle(document.documentElement).getPropertyValue('--text'),
      '--card': toHex(th.secondary_bg_color) || '#ffffff',
      '--acc': toHex(th.button_color) || '#0a84ff',
      '--border': '#e9e9ea',
      '--muted': toHex(th.hint_color) || '#666666'
    };
    Object.entries(map).forEach(([k,v])=> v && document.documentElement.style.setProperty(k, v));
    if (tg.colorScheme === 'dark'){
      document.documentElement.style.setProperty('--border', '#2a2a2a');
    }
    try{ tg.expand(); }catch(e){}
  }

  function prefillFromTelegram(){
    if(!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) return;
    const u = tg.initDataUnsafe.user;
    const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
    if(fullName && !document.getElementById('name').value){
      document.getElementById('name').value = fullName;
    }
    if(u.username && !document.getElementById('username').value){
      document.getElementById('username').value = '@' + u.username;
    }
  }

  function preselectFormat(){
    // ?type=diag|session|pack4|pack8  –∏–ª–∏ DEFAULT_FORMAT
    const url = new URL(window.location.href);
    const t = (url.searchParams.get('type') || DEFAULT_FORMAT || '').trim().toLowerCase();
    const map = { 'diag':'diag', 'diagnostic':'diag', '20':'diag', 'd':'diag',
                  'session':'session', '50':'session', 's':'session',
                  'pack4':'pack4', 'p4':'pack4', '4':'pack4',
                  'pack8':'pack8', 'p8':'pack8', '8':'pack8'};
    const val = map[t];
    if(val){
      const sel = document.getElementById('format');
      sel.value = val;
    }
  }

  function setupMainButton(){
    if(!tg) return;
    tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
    tg.MainButton.show();
    tg.onEvent('mainButtonClicked', submitForm);
  }

  function validate(){
    const req = ['format','name','phone'];
    for(const id of req){
      const el = document.getElementById(id);
      if(!el || !el.value) return false;
    }
    const consent = document.getElementById('consent');
    if(!consent.checked) return false;
    return true;
  }

  function submitForm(e){
    if(e) e.preventDefault();
    if(!validate()){
      alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏.');
      return;
    }
    const payload = {
      kind: 'lead',
      at: new Date().toISOString(),
      // user –∏–∑ Telegram (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
      user: tg?.initDataUnsafe?.user ? {
        id: tg.initDataUnsafe.user.id,
        username: tg.initDataUnsafe.user.username || '',
        name: [tg.initDataUnsafe.user.first_name, tg.initDataUnsafe.user.last_name].filter(Boolean).join(' ')
      } : null,
      // –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
      format: document.getElementById('format').value,        // diag | session | pack4 | pack8
      name: document.getElementById('name').value.trim(),
      username: document.getElementById('username').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      date_pref: document.getElementById('date_pref').value || '',
      time_pref: document.getElementById('time_pref').value || '',
      comment: document.getElementById('comment').value.trim(),
      consent: true,
      tz: Intl.DateTimeFormat().resolvedOptions().timeZone || ''
    };

    if(tg && typeof tg.sendData === 'function'){
      try{
        tg.sendData(JSON.stringify(payload));
        btn.disabled = true;
        note.classList.remove('hidden');
        setTimeout(()=> { try{ tg.close(); }catch(e){} }, 900);
      }catch(err){
        console.error(err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      }
    }else{
      // –§–æ–ª–±—ç–∫ –≤–Ω–µ Telegram: –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      console.log('Payload (local preview):', payload);
      btn.disabled = true;
      note.classList.remove('hidden');
      alert('–§–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–Ω–µ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –µ—ë —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.');
    }
  }

  // –ü—Ä–∏–≤—è–∑–∫–∏
  form.addEventListener('submit', submitForm);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  applyTheme();
  prefillFromTelegram();
  preselectFormat();
  setupMainButton();

  // –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∞–≤–∏–ª–∞, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∞
  if(RULES_URL){
    rulesLink.href = RULES_URL;
  }else{
    rulesLink.removeAttribute('href');
    rulesLink.addEventListener('click', (e)=>{ e.preventDefault(); alert('–ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´üìù –ü—Ä–∞–≤–∏–ª–∞¬ª –±–æ—Ç–∞.'); });
  }
</script>
</body>
</html>
